sequenceDiagram
    actor User
    participant API as OrderController
    participant Service as OrderService
    participant DB as MySQL

    User->>API: POST /api/orders/1/pay
    Note over User,API: {memberId: 1}

    API->>Service: payOrder(orderId=1, memberId=1)
    Service->>DB: START TRANSACTION

    Note over Service,DB: Step 1: 주문 조회
    Service->>DB: SELECT * FROM ordersWHERE order_id = 1

    alt 주문 없음
        DB-->>Service: Empty
        Service->>DB: ROLLBACK
        Service-->>API: OrderNotFoundException
        API-->>User: 404 Not Found
    else 이미 결제됨
        DB-->>Service: Order (status='CONFIRMED')
        Service->>DB: ROLLBACK
        Service-->>API: AlreadyPaidException
        API-->>User: 400 Bad Request{error: "ALREADY_PAID"}
    else 결제 가능
        DB-->>Service: Order (status='PENDING')

        Note over Service,DB: Step 2: 잔액 확인
        Service->>DB: SELECT balanceFROM memberWHERE member_id = 1

        alt 잔액 부족
            DB-->>Service: balance = 10000(필요: 37800)
            Service->>DB: ROLLBACK
            Service-->>API: InsufficientBalanceException
            API-->>User: 409 Conflict{error: "INSUFFICIENT_BALANCE",currentBalance: 10000,requiredAmount: 37800}
        else 잔액 충분
            DB-->>Service: balance = 1000000

            Note over Service,DB: Step 3: 잔액 차감
            Service->>DB: UPDATE memberSET balance = balance - 37800WHERE member_id = 1

            Note over Service,DB: Step 4: 주문 확정
            Service->>DB: UPDATE ordersSET status = 'CONFIRMED'WHERE order_id = 1

            Note over Service,DB: Step 5: 재고 확정
            Service->>DB: SELECT * FROM order_itemWHERE order_id = 1

            loop 각 주문 상품
                Service->>DB: UPDATE stockSET reserved_quantity -= qtyWHERE option_id = ?

                Service->>DB: INSERT INTO stock_history(type='CONFIRM')
            end

            Service->>DB: COMMIT
            Service-->>API: PaymentResponse{orderId, status: "CONFIRMED",paidAmount: 37800,remainingBalance: 962200}
            API-->>User: 200 OK
        end
    end